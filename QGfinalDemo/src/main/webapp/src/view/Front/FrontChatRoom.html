<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>聊天室</title>
    <script src="../../js/vue.js"></script>
    <link rel="stylesheet" href="../../asset/css/global.css">
</head>
<body>
<div id="app" class="Home">
    <div class="header">

        <a href="#" class="ICON">
            <img src="../../asset/img/ICON.png" alt="二手市场" style="position:absolute;bottom:22px">
            <strong style="position:absolute;left:60px;bottom:20px">二手市场</strong>
        </a>

        <h2 style="position: absolute;left:250px;top:14px;color:whitesmoke">前台 > 聊天室</h2>

        <button @click="logout"><strong>{{ currentUser? '退出登录':'进入登录' }}</strong></button>

    </div>

    <div class="left">
        <a href="FrontProduct.html"><strong>首页-来逛逛吧~</strong></a>
        <a href="FrontChatRoom.html" style="border-right: darkcyan solid 5px"><strong>聊天室</strong></a>
        <a href="FrontDeal.html"><strong>我的订单</strong></a>
        <a href="FrontHome.html"><strong>查看修改个人信息</strong></a>
        <a href="FrontSelfProduct.html"><strong>我的商品</strong></a>
    </div>
    <div class="right">

        <div>
            <h1>WebSocket Chat</h1>
            <ul>
                <li v-for="(message, index) in messages" :key="index">{{ message }}</li>
            </ul>
            <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="Type a message...">
            <button @click="sendMessage">Send</button>
        </div>
        <div>head:{{ firstMan }}</div>
        <div>hind:{{ secondMan }}</div>
        <div>{{secondRole}}</div>
    </div>


</div>

<script>
    new Vue({
        el: '#app',
        data: {
            currentUser: null,
            socket:null,
            messages: [],
            newMessage: '',
            firstMan:"",
            secondMan:"",
            secondRole:"",
        },
        mounted() {
            this.init();
            this.LoadAccount();
        },
        methods:{
            init(){

                const urlParams = new URLSearchParams(window.location.search);
                this.firstMan = urlParams.get('firstMan');
                this.secondMan = urlParams.get('secondMan');
                this.secondRole = urlParams.get('secondRole');
            },


            initWebSocket() {
                this.socket = new WebSocket('ws://' + window.location.host + '/QGfinalDemo_war/websocket'); // 替换为你的 WebSocket 服务器地址
                this.socket.onopen = () => {
                    console.log('WebSocket连接已打开');
                };
                this.socket.onmessage = (event) => {
                    this.messages.push(event.data);
                };
                this.socket.onclose = () => {
                    console.log('WebSocket连接已关闭');
                };
                this.socket.onerror = (error) => {
                    this.messages.push(`某人已错误`);
                    console.error('WebSocket发生错误：', error);
                };
            },
            sendMessage() {
                if (this.newMessage.trim() !== '') {
                    this.socket.send(this.newMessage);
                    this.messages.push(`You: ${this.newMessage}`);
                    this.newMessage = '';
                }
            },


            LoadAccount(){
                let LoginHttp;
                if(window.XMLHttpRequest){
                    LoginHttp=new XMLHttpRequest();

                }else{
                    LoginHttp =new ActiveXObject("Microsoft.XMLHTTP");
                }
                LoginHttp.open("POST","http://localhost:8080/QGfinalDemo_war/WebsServlet");
                LoginHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");

                let requestBody ="&method=loadAccount";
                LoginHttp.send(requestBody);
                LoginHttp.onreadystatechange = (event) => { // 使用箭头函数确保 this 指向 Vue 实例
                    if (event.target.readyState === 4 && event.target.status === 200) {

                        const storedUser=JSON.parse(event.target.responseText);

                        if (storedUser)
                            this.currentUser = storedUser.data;
                        else console.log("未找到用户数据");
                        if(this.currentUser.role==="USER")
                            this.initWebSocket();
                        else{
                            this.currentUser=null;
                            alert("你不是用户!");
                        }
                    }
                }
            },
            logout(){
                let LoginHttp;
                if(window.XMLHttpRequest){
                    LoginHttp=new XMLHttpRequest();

                }else{
                    LoginHttp =new ActiveXObject("Microsoft.XMLHTTP");
                }
                LoginHttp.open("POST","http://localhost:8080/QGfinalDemo_war/WebsServlet");
                LoginHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");

                let requestBody ="&method=logout";
                LoginHttp.send(requestBody);
                window.location.href = "../login.html";
            }
        }
    });
</script>
</body>
</html>